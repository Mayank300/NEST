import styled from "styled-components";
import Head from "next/head";
import Sidebar from "../../components/sidebar";
import ChatScreen from "../../components/ChatScreen";
import { auth, db } from "../../firebase";
import { useAuthState } from "react-firebase-hooks/auth";
import getRecipientEmail from "../../utils/getRecipientEmail";

function Chat({ chat, messages }) {
  const [user] = useAuthState(auth);

  return (
    <Container>
      <Head>
        <title>Chat with {getRecipientEmail(chat.users, user)}</title>
        <link
          rel="icon"
          href="data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHZpZXdCb3g9IjAgMCAxNzIgMTcyIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9Im5vbnplcm8iIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBzdHJva2UtbGluZWNhcD0iYnV0dCIgc3Ryb2tlLWxpbmVqb2luPSJtaXRlciIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBzdHJva2UtZGFzaGFycmF5PSIiIHN0cm9rZS1kYXNob2Zmc2V0PSIwIiBmb250LWZhbWlseT0ibm9uZSIgZm9udC13ZWlnaHQ9Im5vbmUiIGZvbnQtc2l6ZT0ibm9uZSIgdGV4dC1hbmNob3I9Im5vbmUiIHN0eWxlPSJtaXgtYmxlbmQtbW9kZTogbm9ybWFsIj48cGF0aCBkPSJNMCwxNzJ2LTE3MmgxNzJ2MTcyeiIgZmlsbD0ibm9uZSI+PC9wYXRoPjxnPjxwYXRoIGQ9Ik0xMzIuNDQsMjAuNjRjLTAuOTQ5OTMsMCAtMS43MiwwLjc3MDA3IC0xLjcyLDEuNzJjMCwwLjk0OTkzIDAuNzcwMDcsMS43MiAxLjcyLDEuNzJjMC45NDk5MywwIDEuNzIsLTAuNzcwMDcgMS43MiwtMS43MmMwLC0wLjk0OTkzIC0wLjc3MDA3LC0xLjcyIC0xLjcyLC0xLjcyeiIgZmlsbD0iI2YxYmMxOSI+PC9wYXRoPjxwYXRoIGQ9Ik04NiwyMi4zNmMtMzUuMTQ3NCwwIC02My42NCwyOC40OTI2IC02My42NCw2My42NGMwLDM1LjE0NzQgMjguNDkyNiw2My42NCA2My42NCw2My42NGMzNS4xNDc0LDAgNjMuNjQsLTI4LjQ5MjYgNjMuNjQsLTYzLjY0YzAsLTM1LjE0NzQgLTI4LjQ5MjYsLTYzLjY0IC02My42NCwtNjMuNjR6IiBmaWxsPSIjZTRlNGY5Ij48L3BhdGg+PHBhdGggZD0iTTE0Mi43NiwxOC45MmMtMy43OTk3MiwwIC02Ljg4LDMuMDgwMjggLTYuODgsNi44OGMwLDMuNzk5NzIgMy4wODAyOCw2Ljg4IDYuODgsNi44OGMzLjc5OTcyLDAgNi44OCwtMy4wODAyOCA2Ljg4LC02Ljg4YzAsLTMuNzk5NzIgLTMuMDgwMjgsLTYuODggLTYuODgsLTYuODh6IiBmaWxsPSIjZjFiYzE5Ij48L3BhdGg+PHBhdGggZD0iTTE0OS42NCwzNy44NGMtMS44OTk4NiwwIC0zLjQ0LDEuNTQwMTQgLTMuNDQsMy40NGMwLDEuODk5ODYgMS41NDAxNCwzLjQ0IDMuNDQsMy40NGMxLjg5OTg2LDAgMy40NCwtMS41NDAxNCAzLjQ0LC0zLjQ0YzAsLTEuODk5ODYgLTEuNTQwMTQsLTMuNDQgLTMuNDQsLTMuNDR6IiBmaWxsPSIjODg4OWI5Ij48L3BhdGg+PHBhdGggZD0iTTEzOS4zMiwxMjcuMjhjLTEuODk5ODYsMCAtMy40NCwxLjU0MDE0IC0zLjQ0LDMuNDRjMCwxLjg5OTg2IDEuNTQwMTQsMy40NCAzLjQ0LDMuNDRjMS44OTk4NiwwIDMuNDQsLTEuNTQwMTQgMy40NCwtMy40NGMwLC0xLjg5OTg2IC0xLjU0MDE0LC0zLjQ0IC0zLjQ0LC0zLjQ0ek0yNS44LDEwMS40OGMtMy43OTk3MiwwIC02Ljg4LDMuMDgwMjggLTYuODgsNi44OGMwLDMuNzk5NzIgMy4wODAyOCw2Ljg4IDYuODgsNi44OGMzLjc5OTcyLDAgNi44OCwtMy4wODAyOCA2Ljg4LC02Ljg4YzAsLTMuNzk5NzIgLTMuMDgwMjgsLTYuODggLTYuODgsLTYuODh6IiBmaWxsPSIjZmJjZDU5Ij48L3BhdGg+PHBhdGggZD0iTTQzLDE0Ni4yYy0xLjg5OTg2LDAgLTMuNDQsMS41NDAxNCAtMy40NCwzLjQ0YzAsMS44OTk4NiAxLjU0MDE0LDMuNDQgMy40NCwzLjQ0YzEuODk5ODYsMCAzLjQ0LC0xLjU0MDE0IDMuNDQsLTMuNDRjMCwtMS44OTk4NiAtMS41NDAxNCwtMy40NCAtMy40NCwtMy40NHoiIGZpbGw9IiM4ODg5YjkiPjwvcGF0aD48cGF0aCBkPSJNMTM2Ljc0LDU1LjA0Yy0xLjQyNDg5LDAgLTIuNTgsMS4xNTUxMSAtMi41OCwyLjU4YzAsMS40MjQ4OSAxLjE1NTExLDIuNTggMi41OCwyLjU4YzEuNDI0ODksMCAyLjU4LC0xLjE1NTExIDIuNTgsLTIuNThjMCwtMS40MjQ4OSAtMS4xNTUxMSwtMi41OCAtMi41OCwtMi41OHoiIGZpbGw9IiNmZmZmZmYiPjwvcGF0aD48cGF0aCBkPSJNMTM1Ljg4LDg4LjkzNjA0YzAsLTEzLjkxODI0IC0xNS4wNDQ4NCwtMjUuMTk5NzIgLTMzLjYwMTkyLC0yNS4xOTk3MmMtMTguNTU3MDgsMCAtMzMuNjAxOTIsMTEuMjgxNDggLTMzLjYwMTkyLDI1LjE5OTcyYzAsMTMuOTE4MjQgMTUuMDQ0ODQsMjUuMTk5NzIgMzMuNjAxOTIsMjUuMTk5NzJoNC4yMDAyNGMzLjU3MjQ0LDMuNTcyNDQgMTAuMTg1ODQsNy4xNDY2IDE3LjI1MTYsOC4xMzM4OGMxLjQzNjIsMC4yMDEyNCAyLjUzMTg0LC0xLjI4MzEyIDEuOTI2NCwtMi42MDA2NGMtMS4zNDE2LC0yLjkyMDU2IC0yLjM3NzA0LC03LjE3NTg0IC0yLjM3NzA0LC0xMS4wNDQxMnYwYzcuOTcwNDgsLTQuNzg2NzYgMTIuNjA3NiwtMTIuMDMxNCAxMi42MDA3MiwtMTkuNjg4ODQiIGZpbGw9IiNmY2JhN2YiPjwvcGF0aD48cGF0aCBkPSJNMTIzLjk4NDQ4LDEyMy40OTA4NGMtMC4xNDEwNCwwIC0wLjI4MDM2LC0wLjAwODYgLTAuNDIxNCwtMC4wMjkyNGMtNi40OTMsLTAuOTA2NDQgLTEzLjMyNjU2LC00LjA3Mjk2IC0xNy41NzMyNCwtOC4xMjE4NGgtMy43MTE3NmMtMTkuMTkxNzYsMCAtMzQuODA1OTIsLTExLjg0NTY0IC0zNC44MDU5MiwtMjYuNDA1NDRjMCwtMTQuNTU5OCAxNS42MTQxNiwtMjYuNDA1NDQgMzQuODA1OTIsLTI2LjQwNTQ0YzE5LjE5MTc2LDAgMzQuODA1OTIsMTEuODQ3MzYgMzQuODA1OTIsMjYuNDA3MTZ2LTAuMDAxNzJjMC4wMDY4OCw3LjkzNzggLTQuNTcxNzYsMTUuMzI1MiAtMTIuNTg4NjgsMjAuMzU3OTJjMC4xMDQ5MiwzLjI2OCAwLjk2ODM2LDcuMDY5MiAyLjI1NjY0LDkuODc0NTJjMC40NjQ0LDEuMDEzMDggMC4zMzg4NCwyLjE5ODE2IC0wLjMyODUyLDMuMDk2Yy0wLjU4MTM2LDAuNzc5MTYgLTEuNDg3OCwxLjIyODA4IC0yLjQzODk2LDEuMjI4MDh6TTEwMi4yNzgwOCw2NC45NDAzMmMtMTcuODYzOTIsMCAtMzIuMzk2MiwxMC43NjU0OCAtMzIuMzk2MiwyMy45OTU3MmMwLDEzLjIzMDI0IDE0LjUzMjI4LDIzLjk5NTcyIDMyLjM5NjIsMjMuOTk1NzJoNC42OTkwNGwwLjM1MjYsMC4zNTI2YzMuMTY5OTYsMy4xNzE2OCA5LjUyMDIsNi44MDk0OCAxNi41NjUzMiw3Ljc5MTZjMC4zNDQsMC4wNTMzMiAwLjUyNjMyLC0wLjE1OTk2IDAuNTkzNCwtMC4yNTExMmMwLjA3MDUyLC0wLjA5Mjg4IDAuMjE1LC0wLjM0MjI4IDAuMDcyMjQsLTAuNjUzNmMtMS41MzQyNCwtMy4zMzY4IC0yLjQ4NzEyLC03Ljc2MjM2IC0yLjQ4NzEyLC0xMS41NDYzNnYtMC42ODExMmwwLjU4NDgsLTAuMzQ5MTZjNy42NDE5NiwtNC41OTA2OCAxMi4wMjI4LC0xMS4zOTE1NiAxMi4wMTU5MiwtMTguNjU2ODR2LTAuMDAxNzJjMC4wMDE3MiwtMTMuMjMwMjQgLTE0LjUzMDU2LC0yMy45OTU3MiAtMzIuMzk2MiwtMjMuOTk1NzJ6IiBmaWxsPSIjNDcyYjI5Ij48L3BhdGg+PGc+PHBhdGggZD0iTTM3Ljg0LDc2LjgwODMyYy0wLjAwNjg4LDkuMjMxMjQgNS42OTE0OCwxNy45NjM2OCAxNS40ODg2LDIzLjczMjU2djBjMCw0Ljk4NjI4IC0xLjQ1MzQsMTAuNTA1NzYgLTMuMjY5NzIsMTQuMDIxNDRjLTAuNjQ1LDEuMjQ3IDAuMzY0NjQsMi42OTg2OCAxLjc1OTU2LDIuNTQ1NmM5LjA0MjA0LC0wLjk5MjQ0IDE3LjYwOTM2LC01LjQ1NzU2IDIyLjE2MjIsLTkuOTIyNjhoNS4xNjM0NGMyMi44MTIzNiwwIDQxLjMwNDA4LC0xMy42MDE3NiA0MS4zMDQwOCwtMzAuMzc4NjRjMCwtMTYuNzc2ODggLTE4LjQ5MTcyLC0zMC4zNzY5MiAtNDEuMzA0MDgsLTMwLjM3NjkyYy0yMi44MTIzNiwwIC00MS4zMDQwOCwxMy42MDAwNCAtNDEuMzA0MDgsMzAuMzc4NjQiIGZpbGw9IiNmZWQ1YjMiPjwvcGF0aD48cGF0aCBkPSJNNTEuNjI0MDgsMTE4LjMyMzk2Yy0wLjk3MzUyLDAgLTEuODg4NTYsLTAuNDc0NzIgLTIuNDQ1ODQsLTEuMjg2NTZjLTAuNjE1NzYsLTAuODk3ODQgLTAuNjg4LC0yLjA1ODg0IC0wLjE4NzQ4LC0zLjAyNzJjMS43ODE5MiwtMy40NDg2IDMuMDA2NTYsLTguNTAxOTYgMy4xMjUyNCwtMTIuNzkzMzZjLTkuODU1NiwtNi4wMTgyOCAtMTUuNDg2ODgsLTE0Ljg4MzE2IC0xNS40OCwtMjQuNDExOTZjMCwtMTcuNDEzMjggMTkuMDY5NjQsLTMxLjU4MDkyIDQyLjUwODA4LC0zMS41ODA5MmMyMy40NDAxNiwwIDQyLjUwOTgsMTQuMTY3NjQgNDIuNTA5OCwzMS41ODI2NGMwLDE3LjQxNSAtMTkuMDY5NjQsMzEuNTg0MzYgLTQyLjUwOTgsMzEuNTg0MzZoLTQuNjgwMTJjLTQuNTMyMiw0LjI1MTg0IC0xMy4xMTMyOCw4Ljg4MjA4IC0yMi41MTMwOCw5LjkxNThjLTAuMTA4MzYsMC4wMTIwNCAtMC4yMTg0NCwwLjAxNzIgLTAuMzI2OCwwLjAxNzJ6TTc5LjE0NDA4LDQ3LjYzMTk2Yy0yMi4xMTA2LDAgLTQwLjEwMDA4LDEzLjA4NzQ4IC00MC4xMDAwOCwyOS4xNzQ2NHYwLjAwMTcyYy0wLjAwNjg4LDguODQ1OTYgNS40MjE0NCwxNy4xMTc0NCAxNC44OTUyLDIyLjY5MzY4bDAuNTkzNCwwLjM0OTE2djAuNjg4YzAsNC44NTA0IC0xLjMzNjQ0LDEwLjU3MTEyIC0zLjQwMzg4LDE0LjU3NTI4Yy0wLjEzMDcyLDAuMjUxMTIgLTAuMDM2MTIsMC40NTkyNCAwLjAzNDQsMC41NTcyOGMwLjA1Njc2LDAuMDgyNTYgMC4yMjM2LDAuMjgwMzYgMC41MjQ2LDAuMjM5MDhjOS4wODMzMiwtMC45OTc2IDE3LjMxNjk2LC01LjUzNDk2IDIxLjQ1MDEyLC05LjU4NTU2bDAuMzUwODgsLTAuMzQ0aDUuNjU1MzZjMjIuMTEyMzIsMCA0MC4xMDAwOCwtMTMuMDg3NDggNDAuMTAwMDgsLTI5LjE3NDY0YzAsLTE2LjA4NzE2IC0xNy45ODc3NiwtMjkuMTc0NjQgLTQwLjEwMDA4LC0yOS4xNzQ2NHoiIGZpbGw9IiM0NzJiMjkiPjwvcGF0aD48L2c+PGcgZmlsbD0iIzQ3MmIyOSI+PHBhdGggZD0iTTgzLjQyLDYxLjkyaC0yNC4wOGMtMC40NzQ3MiwwIC0wLjg2LC0wLjM4NTI4IC0wLjg2LC0wLjg2YzAsLTAuNDc0NzIgMC4zODUyOCwtMC44NiAwLjg2LC0wLjg2aDI0LjA4YzAuNDc0NzIsMCAwLjg2LDAuMzg1MjggMC44NiwwLjg2YzAsMC40NzQ3MiAtMC4zODUyOCwwLjg2IC0wLjg2LDAuODZ6Ij48L3BhdGg+PC9nPjxnIGZpbGw9IiM0NzJiMjkiPjxwYXRoIGQ9Ik0xMDIuMzQsNjEuOTJoLTEyLjA0Yy0wLjQ3NDcyLDAgLTAuODYsLTAuMzg1MjggLTAuODYsLTAuODZjMCwtMC40NzQ3MiAwLjM4NTI4LC0wLjg2IDAuODYsLTAuODZoMTIuMDRjMC40NzQ3MiwwIDAuODYsMC4zODUyOCAwLjg2LDAuODZjMCwwLjQ3NDcyIC0wLjM4NTI4LDAuODYgLTAuODYsMC44NnoiPjwvcGF0aD48L2c+PGcgZmlsbD0iIzQ3MmIyOSI+PHBhdGggZD0iTTcwLjk1LDcyLjY3aC0yMS4wN2MtMC40NzQ3MiwwIC0wLjg2LC0wLjM4NTI4IC0wLjg2LC0wLjg2YzAsLTAuNDc0NzIgMC4zODUyOCwtMC44NiAwLjg2LC0wLjg2aDIxLjA3YzAuNDc0NzIsMCAwLjg2LDAuMzg1MjggMC44NiwwLjg2YzAsMC40NzQ3MiAtMC4zODUyOCwwLjg2IC0wLjg2LDAuODZ6Ij48L3BhdGg+PC9nPjxnIGZpbGw9IiM0NzJiMjkiPjxwYXRoIGQ9Ik0xMDUuNzgsNzIuNjdoLTI3LjUyYy0wLjQ3NDcyLDAgLTAuODYsLTAuMzg1MjggLTAuODYsLTAuODZjMCwtMC40NzQ3MiAwLjM4NTI4LC0wLjg2IDAuODYsLTAuODZoMjcuNTJjMC40NzQ3MiwwIDAuODYsMC4zODUyOCAwLjg2LDAuODZjMCwwLjQ3NDcyIC0wLjM4NTI4LDAuODYgLTAuODYsMC44NnoiPjwvcGF0aD48L2c+PGcgZmlsbD0iIzQ3MmIyOSI+PHBhdGggZD0iTTEwOC43OSw4My40MmgtMTUuMDVjLTAuNDc0NzIsMCAtMC44NiwtMC4zODUyOCAtMC44NiwtMC44NmMwLC0wLjQ3NDcyIDAuMzg1MjgsLTAuODYgMC44NiwtMC44NmgxNS4wNWMwLjQ3NDcyLDAgMC44NiwwLjM4NTI4IDAuODYsMC44NmMwLDAuNDc0NzIgLTAuMzg1MjgsMC44NiAtMC44NiwwLjg2eiI+PC9wYXRoPjwvZz48ZyBmaWxsPSIjNDcyYjI5Ij48cGF0aCBkPSJNODYuNDMsODMuNDJoLTM3LjQxYy0wLjQ3NDcyLDAgLTAuODYsLTAuMzg1MjggLTAuODYsLTAuODZjMCwtMC40NzQ3MiAwLjM4NTI4LC0wLjg2IDAuODYsLTAuODZoMzcuNDFjMC40NzQ3MiwwIDAuODYsMC4zODUyOCAwLjg2LDAuODZjMCwwLjQ3NDcyIC0wLjM4NTI4LDAuODYgLTAuODYsMC44NnoiPjwvcGF0aD48L2c+PGcgZmlsbD0iIzQ3MmIyOSI+PHBhdGggZD0iTTEwMi43Nyw5NC4xN2gtNDUuMTVjLTAuNDc0NzIsMCAtMC44NiwtMC4zODUyOCAtMC44NiwtMC44NmMwLC0wLjQ3NDcyIDAuMzg1MjgsLTAuODYgMC44NiwtMC44Nmg0NS4xNWMwLjQ3NDcyLDAgMC44NiwwLjM4NTI4IDAuODYsMC44NmMwLDAuNDc0NzIgLTAuMzg1MjgsMC44NiAtMC44NiwwLjg2eiI+PC9wYXRoPjwvZz48L2c+PC9nPjwvc3ZnPg=="
        />
      </Head>
      <Sidebar />
      <ChatContainer>
        <ChatScreen chat={chat} messages={messages} />
      </ChatContainer>
    </Container>
  );
}

export default Chat;

export async function getServerSideProps(context) {
  const ref = db.collection("chats").doc(context.query.id);
  const messagesRes = await ref
    .collection("messages")
    .orderBy("timestamp", "asc")
    .get();

  const messages = messagesRes.docs
    .map((doc) => ({
      id: doc.id,
      ...doc.data(),
    }))
    .map((messages) => ({
      ...messages,
      timestamp: messages.timestamp.toDate().getTime(),
    }));

  const chatRes = await ref.get();
  const chat = {
    id: chatRes.id,
    ...chatRes.data(),
  };

  return {
    props: {
      messages: JSON.stringify(messages),
      chat: chat,
    },
  };
}

const Container = styled.div`
  display: flex;
`;

const ChatContainer = styled.div`
  flex: 1;
  overflow: scroll;
  height: 100vh;

  ::webkit-scrollbar {
    display: none;
  }
  -ms-overflow-style: none;
  scrollbar-width: none;
`;
